<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Real-time bus tracker</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}

		.map-overlay {
			position: absolute;
			left: 0;
			padding: 10px;
		}

		.mapboxgl-popup {
			max-width: 200px;
		}

		.mapboxgl-popup-content {
			text-align: left;
			font-family: 'Open Sans', sans-serif;
		}

		.marker {
			background-image: url('mapbox-icon.png');
			background-size: cover;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			cursor: pointer;
		}
	</style>
</head>

<body>

	<div id="map"></div>
	<div class="map-overlay top">
		<select style="font-size: 1em;" id="routesList" onchange="getNewRoute(this.value)">
			<option value="none"> ---Choose the route--- </option>
		</select>
	</div>

	<script>

		mapboxgl.accessToken = 'YOUR_MAPBOX_API_KEY'

		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			center: [-71.104, 42.351],
			zoom: 13
		});

		var markers = [];
		var route = null;
		var stops = null;

		async function populateTheDropDownListOfRoutes() {
			let routes = [];

			const url = 'https://api-v3.mbta.com/routes';
			const response = await fetch(url);
			const json = await response.json();

			json.data.forEach(route => {
				routes.push({
					value: route.id,
					text: route.attributes.long_name === route.attributes.direction_destinations.join(" - ") ? route.attributes.long_name : route.attributes.long_name + ': ' + route.attributes.direction_destinations.join(' <=> ')
				})
			})

			const routeListSelect = document.getElementById("routesList");

			routes.forEach(route => {
				var option = document.createElement("option");
				option.value = route.value;
				option.text = route.text;
				routeListSelect.appendChild(option)
			})

		}

		async function getNewRoute(routeId) {
			if (routeId === "none") return;
			// get bus data    
			route = await getRouteDetails(routeId);
			startTracking();
		}

		async function startTracking() {
			const locations = await getBusLocations();

			markers.forEach(marker => {
				marker.remove();
			})

			markers.splice(0, markers.length);

			locations.forEach(location => {
				var marker = new mapboxgl.Marker()
					.setLngLat([location.attributes.longitude, location.attributes.latitude])
					.setPopup(
						new mapboxgl.Popup({ offset: 25 }) // add popups
							.setHTML(
								`<h3>${route.attributes.long_name}</h3>
								<p>
									<ul>
										<li>
											status: ${location.attributes.current_status}
										</li>
										<li>
											stop station: ${stops.filter(s => s.id === location.relationships.stop.data.id)[0].attributes.name}		
										</li>
									</ul>					
								</p>`
							)
					)
					.addTo(map);
				markers.push(marker);
			});

			setTimeout(startTracking, 15000);
		}

		// Request bus data from MBTA
		async function getBusLocations() {
			const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
			const response = await fetch(url);
			const json = await response.json();
			return json.data;
		}

		async function getRouteDetails(routeId) {
			const url = 'https://api-v3.mbta.com/routes/' + routeId;
			const response = await fetch(url);
			const json = await response.json();
			return json.data;
		}

		async function getStopDetails() {
			const url = 'https://api-v3.mbta.com/stops';
			const response = await fetch(url);
			const json = await response.json();
			stops = json.data;
		}

		populateTheDropDownListOfRoutes();
		getStopDetails();

	</script>

</body>

</html>